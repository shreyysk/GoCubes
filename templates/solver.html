{% extends "base.html" %}

{% block title %}Solver - Rubik's Cube Solver{% endblock %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}" style="display:none;">
<div class="row">
    <div class="col-md-12">
        <h2 class="mb-4">
            <i class="fas fa-puzzle-piece"></i> Cube Solver
        </h2>

        <ul class="nav nav-tabs" id="inputTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button">
                    <i class="fas fa-hand-pointer"></i> Manual Input
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="camera-tab" data-bs-toggle="tab" data-bs-target="#camera" type="button">
                    <i class="fas fa-camera"></i> Camera Scan
                </button>
            </li>
        </ul>
        
        <div class="tab-content mt-4" id="inputTabContent">
            <div class="tab-pane fade show active" id="manual" role="tabpanel">
                <div class="row">
                    <div class="col-lg-8">
                        <h4>Select Colors for Each Face</h4>
                        <p>Click on each sticker to set its color. The center colors are fixed.</p>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>Current Color:</strong>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-secondary" id="undoBtn" title="Undo (Ctrl+Z)">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="redoBtn" title="Redo (Ctrl+Y)">
                                        <i class="fas fa-redo"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="btn-group w-100" role="group" id="colorPalette">
                                <button type="button" class="btn btn-outline-secondary color-btn" data-color="W" title="White (W)">
                                    <div class="color-swatch" style="background: white; border: 1px solid #ddd;"></div>
                                    <small>White</small>
                                </button>
                                <button type="button" class="btn btn-outline-secondary color-btn" data-color="Y" title="Yellow (Y)">
                                    <div class="color-swatch" style="background: #ffc107;"></div>
                                    <small>Yellow</small>
                                </button>
                                <button type="button" class="btn btn-outline-secondary color-btn" data-color="R" title="Red (R)">
                                    <div class="color-swatch" style="background: #dc3545;"></div>
                                    <small>Red</small>
                                </button>
                                <button type="button" class="btn btn-outline-secondary color-btn" data-color="O" title="Orange (O)">
                                    <div class="color-swatch" style="background: #fd7e14;"></div>
                                    <small>Orange</small>
                                </button>
                                <button type="button" class="btn btn-outline-secondary color-btn" data-color="G" title="Green (G)">
                                    <div class="color-swatch" style="background: #28a745;"></div>
                                    <small>Green</small>
                                </button>
                                <button type="button" class="btn btn-outline-secondary color-btn active" data-color="B" title="Blue (B)">
                                    <div class="color-swatch" style="background: #007bff;"></div>
                                    <small>Blue</small>
                                </button>
                            </div>
                        </div>
                        
                        <div class="d-flex flex-wrap justify-content-center">
                            <div class="text-center p-2">
                                <h5>Up (White)</h5>
                                <div class="cube-face-grid" data-face="up">
                                    <div class="cube-sticker sticker-W" data-index="0"></div><div class="cube-sticker sticker-W" data-index="1"></div><div class="cube-sticker sticker-W" data-index="2"></div>
                                    <div class="cube-sticker sticker-W" data-index="3"></div><div class="cube-sticker sticker-W" data-index="4" style="cursor: not-allowed;">W</div><div class="cube-sticker sticker-W" data-index="5"></div>
                                    <div class="cube-sticker sticker-W" data-index="6"></div><div class="cube-sticker sticker-W" data-index="7"></div><div class="cube-sticker sticker-W" data-index="8"></div>
                                </div>
                            </div>
                             <div class="text-center p-2">
                                <h5>Left (Green)</h5>
                                <div class="cube-face-grid" data-face="left">
                                    <div class="cube-sticker sticker-G" data-index="0"></div><div class="cube-sticker sticker-G" data-index="1"></div><div class="cube-sticker sticker-G" data-index="2"></div>
                                    <div class="cube-sticker sticker-G" data-index="3"></div><div class="cube-sticker sticker-G" data-index="4" style="cursor: not-allowed;">G</div><div class="cube-sticker sticker-G" data-index="5"></div>
                                    <div class="cube-sticker sticker-G" data-index="6"></div><div class="cube-sticker sticker-G" data-index="7"></div><div class="cube-sticker sticker-G" data-index="8"></div>
                                </div>
                            </div>
                             <div class="text-center p-2">
                                <h5>Front (Red)</h5>
                                <div class="cube-face-grid" data-face="front">
                                    <div class="cube-sticker sticker-R" data-index="0"></div><div class="cube-sticker sticker-R" data-index="1"></div><div class="cube-sticker sticker-R" data-index="2"></div>
                                    <div class="cube-sticker sticker-R" data-index="3"></div><div class="cube-sticker sticker-R" data-index="4" style="cursor: not-allowed;">R</div><div class="cube-sticker sticker-R" data-index="5"></div>
                                    <div class="cube-sticker sticker-R" data-index="6"></div><div class="cube-sticker sticker-R" data-index="7"></div><div class="cube-sticker sticker-R" data-index="8"></div>
                                </div>
                            </div>
                            <div class="text-center p-2">
                                <h5>Right (Blue)</h5>
                                <div class="cube-face-grid" data-face="right">
                                    <div class="cube-sticker sticker-B" data-index="0"></div><div class="cube-sticker sticker-B" data-index="1"></div><div class="cube-sticker sticker-B" data-index="2"></div>
                                    <div class="cube-sticker sticker-B" data-index="3"></div><div class="cube-sticker sticker-B" data-index="4" style="cursor: not-allowed;">B</div><div class="cube-sticker sticker-B" data-index="5"></div>
                                    <div class="cube-sticker sticker-B" data-index="6"></div><div class="cube-sticker sticker-B" data-index="7"></div><div class="cube-sticker sticker-B" data-index="8"></div>
                                </div>
                            </div>
                            <div class="text-center p-2">
                                <h5>Back (Orange)</h5>
                                <div class="cube-face-grid" data-face="back">
                                    <div class="cube-sticker sticker-O" data-index="0"></div><div class="cube-sticker sticker-O" data-index="1"></div><div class="cube-sticker sticker-O" data-index="2"></div>
                                    <div class="cube-sticker sticker-O" data-index="3"></div><div class="cube-sticker sticker-O" data-index="4" style="cursor: not-allowed;">O</div><div class="cube-sticker sticker-O" data-index="5"></div>
                                    <div class="cube-sticker sticker-O" data-index="6"></div><div class="cube-sticker sticker-O" data-index="7"></div><div class="cube-sticker sticker-O" data-index="8"></div>
                                </div>
                            </div>
                            <div class="text-center p-2">
                                <h5>Down (Yellow)</h5>
                                <div class="cube-face-grid" data-face="down">
                                    <div class="cube-sticker sticker-Y" data-index="0"></div><div class="cube-sticker sticker-Y" data-index="1"></div><div class="cube-sticker sticker-Y" data-index="2"></div>
                                    <div class="cube-sticker sticker-Y" data-index="3"></div><div class="cube-sticker sticker-Y" data-index="4" style="cursor: not-allowed;">Y</div><div class="cube-sticker sticker-Y" data-index="5"></div>
                                    <div class="cube-sticker sticker-Y" data-index="6"></div><div class="cube-sticker sticker-Y" data-index="7"></div><div class="cube-sticker sticker-Y" data-index="8"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="corner-cube mb-3" id="manual-cube-container">
                            <div class="corner-cube-header">
                                <span>Live 3D View</span>
                                <button class="btn btn-sm btn-link" id="toggleManualCube" title="Toggle size">
                  _                 <i class="fas fa-expand"></i>
                                </button>
                            </div>
                            <div class="corner-cube-canvas" id="manual-cube-3d"></div>
                        </div>

                         <div class="p-3 bg-light rounded">
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary btn-lg" id="solveCubeBtn"><i class="fas fa-magic"></i> Solve Cube</button>
                                <button class="btn btn-secondary" id="resetCubeBtn"><i class="fas fa-undo"></i> Reset All</button>
                                <button class="btn btn-info" id="randomScrambleBtn"><i class="fas fa-random"></i> Random Scramble</button>
                            </div>
                        </div>
                        <div class="card mt-3">
                            <div class="card-header bg-secondary text-white"><i class="fas fa-calculator"></i> Color Counter</div>
                            <div class="card-body" id="colorCounter">
                                <div class="d-flex justify-content-between mb-2"><span><span class="badge bg-white text-dark">W</span> White:</span><span id="countW">9</span>/9</div>
                                <div class="d-flex justify-content-between mb-2"><span><span class="badge bg-warning">Y</span> Yellow:</span><span id="countY">9</span>/9</div>
                                <div class="d-flex justify-content-between mb-2"><span><span class="badge bg-danger">R</span> Red:</span><span id="countR">9</span>/9</div>
                                <div class="d-flex justify-content-between mb-2"><span><span class="badge" style="background-color: #fd7e14;">O</span> Orange:</span><span id="countO">9</span>/9</div>
                                <div class="d-flex justify-content-between mb-2"><span><span class="badge bg-success">G</span> Green:</span><span id="countG">9</span>/9</div>
                                <div class="d-flex justify-content-between"><span><span class="badge bg-primary">B</span> Blue:</span><span id="countB">9</span>/9</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="camera" role="tabpanel">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="mb-4">
                            <div class="btn-group w-100 mb-3" role="group">
                                <button type="button" class="btn btn-outline-primary active" id="liveCameraBtn">
                                    <i class="fas fa-video"></i> Live Camera
                                </button>
                                <button type="button" class="btn btn-outline-primary" id="uploadFilesBtn">
                                    <i class="fas fa-upload"></i> Upload Files
                                </button>
                            </div>
                            
                            <div id="liveCameraSection">
                                <div class="position-relative">
                                    <video id="cameraVideo" class="w-100 rounded" style="max-height: 400px; background: #000;" autoplay playsinline></video>
                                    <canvas id="cameraCanvas" class="d-none"></canvas>
                                    <div class="position-absolute top-50 start-50 translate-middle" id="cameraOverlay">
                                        <div class="text-white text-center">
                                            <div class="spinner-border mb-2" role="status"></div>
                                            <p>Initializing camera...</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3 text-center">
                                    <button class="btn btn-success btn-lg" id="startCameraBtn">
                                        <i class="fas fa-camera"></i> Start Camera
                                    </button>
                                    <button class="btn btn-danger btn-lg d-none" id="stopCameraBtn">
                                        <i class="fas fa-stop"></i> Stop Camera
                                    </button>
                                </div>
                                <div class="row mt-3" id="capturedFaces">
                                    </div>
                            </div>
                            
                            <div id="fileUploadSection" class="d-none">
                                <div class="row">
                                    {% for i in range(scanOrder|length) %}
                                    {% set face_key = scanOrder[i] %}
                                    {% set face_name = scanFaceNames[i] %}
                                    <div class="col-md-4 mb-3">
                                        <div class="upload-area" data-face="{{ face_key }}">
                                            <div class="upload-area-content">
                                                <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                                                <h5>{{ face_name }}</h5>
                                                <p>Click to upload image</p>
                                                <input type="file" class="face-upload" id="{{ face_key }}-upload" accept="image/*" style="display: none;">
                                                <img class="preview-img d-none">
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="corner-cube mb-3" id="camera-cube-container">
                            <div class="corner-cube-header">
                                <span>Live 3D View</span>
                                <button class="btn btn-sm btn-link" id="toggleCameraCube" title="Toggle size">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                            <div class="corner-cube-canvas" id="camera-cube-3d"></div>
                        </div>
                         <div class="p-3 bg-light rounded">
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary btn-lg" id="processImagesBtn"><i class="fas fa-camera"></i> Scan with Camera</button>
                            </div>
                             <div class="card mt-3">
                                <div class="card-header bg-warning"><i class="fas fa-lightbulb"></i> Tips for Best Results</div>
                                <div class="card-body"><ul class="mb-0 small"><li>Use good, even lighting.</li><li>Avoid shadows and glare.</li><li>Keep the cube face parallel to the camera.</li><li>Ensure all 9 stickers are clearly visible.</li><li>Use a plain, contrasting background.</li></ul></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="solution-display d-none mt-4" id="solutionDisplay">
            <h3><i class="fas fa-check-circle text-success"></i> Solution Found!</h3>
            <p><strong>Move Count:</strong> <span id="moveCount">0</span> moves</p>
            <div class="row">
                <div class="col-lg-7">
                    <div class="solution-moves-container">
                        <div class="solution-moves" id="solutionMoves"></div>
                    </div>
                    <div class="mt-3" id="animationControls">
                        <div class="d-flex align-items-center mb-2">
                            <label class="me-2 small">Speed:</label>
                            <input type="range" class="form-range flex-grow-1" id="animationSpeed" min="100" max="1000" value="300" step="50">
                            <span class="ms-2 badge bg-secondary" id="speedValue">300ms</span>
                        </div>
                        <div class="btn-toolbar justify-content-center" role="toolbar">
                            <div class="btn-group me-2" role="group">
                                <button class="btn btn-outline-primary" id="prevStepBtn" title="Previous (←)">
                                    <i class="fas fa-step-backward"></i>
                                </button>
                                <button class="btn btn-success" id="playBtn" title="Play (Space)">
                                    <i class="fas fa-play"></i> Play
                                </button>
                                <button class="btn btn-warning d-none" id="pauseBtn" title="Pause (Space)">
                                    <i class="fas fa-pause"></i> Pause
                                </button>
                                <button class="btn btn-outline-primary" id="nextStepBtn" title="Next (→)">
                                    <i class="fas fa-step-forward"></i>
                                </button>
                            </div>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-danger" id="resetAnimationBtn" title="Reset (R)">
                                    <i class="fas fa-undo"></i> Reset
                                </button>
                            </div>
                        </div>
                        <div class="progress mt-2" style="height: 6px;">
                            <div class="progress-bar" id="solutionProgress" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-5 mt-3 mt-lg-0">
                    <div id="cube3d-container" class="cube-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/cube_model.js') }}"></script>
<script src="{{ url_for('static', filename='js/cube3d.js') }}"></script>
<script src="{{ url_for('static', filename='js/solver_logic.js') }}"></script>
<script src="{{ url_for('static', filename='js/image_processor.js') }}"></script>
<script src="{{ url_for('static', filename='js/solver.js') }}"></script>
{% endblock %}